---
apiVersion: v1
kind: Service
metadata:
  name: mongodb
  namespace: glucosync-data
  labels:
    app: mongodb
spec:
  ports:
    - port: 27017
      name: mongodb
  clusterIP: None
  selector:
    app: mongodb
---
apiVersion: v1
kind: Service
metadata:
  name: mongodb-client
  namespace: glucosync-data
  labels:
    app: mongodb
spec:
  ports:
    - port: 27017
      targetPort: 27017
  selector:
    app: mongodb
  type: ClusterIP
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mongodb
  namespace: glucosync-data
spec:
  serviceName: mongodb
  replicas: 3
  selector:
    matchLabels:
      app: mongodb
  template:
    metadata:
      labels:
        app: mongodb
    spec:
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app
                    operator: In
                    values:
                      - mongodb
              topologyKey: kubernetes.io/hostname
      terminationGracePeriodSeconds: 30
      containers:
        - name: mongodb
          image: mongo:7.0
          command:
            - mongod
            - "--replSet"
            - rs0
            - "--bind_ip_all"
          ports:
            - containerPort: 27017
              name: mongodb
          env:
            - name: MONGO_INITDB_ROOT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: root-username
            - name: MONGO_INITDB_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mongodb-credentials
                  key: root-password
          volumeMounts:
            - name: data
              mountPath: /data/db
            - name: config
              mountPath: /etc/mongo
          livenessProbe:
            exec:
              command:
                - mongo
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            exec:
              command:
                - mongo
                - --eval
                - "db.adminCommand('ping')"
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            requests:
              cpu: 500m
              memory: 2Gi
            limits:
              cpu: 2000m
              memory: 4Gi
      volumes:
        - name: config
          configMap:
            name: mongodb-config
  volumeClaimTemplates:
    - metadata:
        name: data
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: longhorn
        resources:
          requests:
            storage: 50Gi
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-config
  namespace: glucosync-data
data:
  mongod.conf: |
    storage:
      dbPath: /data/db
      journal:
        enabled: true
    systemLog:
      destination: file
      logAppend: true
      path: /var/log/mongodb/mongod.log
    net:
      port: 27017
      bindIp: 0.0.0.0
    replication:
      replSetName: rs0
    security:
      authorization: enabled
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: mongodb-init
  namespace: glucosync-data
data:
  init-replica-set.sh: |
    #!/bin/bash
    set -e

    # Wait for MongoDB to be ready
    until mongo --eval "db.adminCommand('ping')" > /dev/null 2>&1; do
      echo "Waiting for MongoDB to be ready..."
      sleep 2
    done

    # Check if replica set is already initialized
    if mongo --eval "rs.status()" | grep -q "no replset config"; then
      echo "Initializing replica set..."
      mongo --eval "rs.initiate({
        _id: 'rs0',
        members: [
          { _id: 0, host: 'mongodb-0.mongodb.glucosync-data.svc.cluster.local:27017', priority: 2 },
          { _id: 1, host: 'mongodb-1.mongodb.glucosync-data.svc.cluster.local:27017', priority: 1 },
          { _id: 2, host: 'mongodb-2.mongodb.glucosync-data.svc.cluster.local:27017', priority: 1 }
        ]
      })"
      echo "Replica set initialized successfully"
    else
      echo "Replica set already initialized"
    fi
